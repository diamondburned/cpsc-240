PWD := $(shell pwd)
DIR := $(shell basename $(PWD))

# Who thought implicit rules were a good idea?
.SUFFIXES:

all: main.out

clean:
	rm -f *.out *.o
	rm -f atof.asm
	rm -f ftoa.asm

define ctoasm
	gcc -Wall -Os -fno-stack-protector -s -c -o $(1).o $(1)
	objconv -v0 -fnasm $(1).o $(1).asm
	dos2unix -q $(1).asm
	sed -i \
		-e 's/;.*$$//' \
		-e 's/?_\([0-9]*\)/.\1/g' \
		-e 's/^default rel//g' \
		-e 's/^SECTION \(\.\w*\).*$$/section \1/g' \
		-e 's/^global \(\w*\):.*$$/global \1/g' \
		-e 's/^section \.\(note\|eh_frame\)//g' \
		-e 's/ \+\(db\|dd\) .*//g' \
		-e 's/^\([^ ]*\):\(.*\)$$/\1:\n\2/g' \
		$(1).asm
	command -v nasmfmt &> /dev/null && nasmfmt $(1).asm
	echo > $(1).asm.cmt
	echo '; Code generated by make $(2). DO NOT EDIT.' >> $(1).asm.cmt
	echo >> $(1).asm.cmt
	cat $(1) \
		| sed -n '/\(^\/\/\|^$$\)/p' \
		| sed -e 's/\/\//;/' -e 's/^;$$/; /g' \
		>> $(1).asm.cmt
	# Merge the comments into the assembly.
	cat $(1).asm.cmt $(1).asm > $(2)
	command -v nasmfmt &> /dev/null && nasmfmt $(2)
	rm $(1).asm.cmt $(1).asm $(1).o
endef

atof.asm: _atof.c
	$(call ctoasm,_atof.c,atof.asm)

ftoa.asm: _ftoa.c
	$(call ctoasm,_ftoa.c,ftoa.asm)

main.out: atof.asm ftoa.asm _lib.asm _math.asm exit.asm itoa.asm print.asm print_int.asm scan.asm main.asm
	if [ -f build.sh ]; then ./build.sh; else build; fi
	mv ${DIR}.out main.out
